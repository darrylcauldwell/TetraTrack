You are improving an iOS and Apple Watch app that measures horse gait, rider balance, training quality, and ride insights using rider-mounted IMU sensors. Each riding session is associated with a Horse Profile. The Horse Profile contains the horse's date of birth, weight, height at withers, and breed. These parameters must be used to scale biomechanical models, normalize signals between horses, and improve speed estimation and gait thresholds.

The app must provide the following outputs for each ride: gait (walk, trot, canter, gallop), canter lead, stride frequency, speed, rein balance (left versus right), turn balance (angle-based), canter lead quality, rider symmetry, rhythm and regularity, transition quality, lead consistency, symmetry score (lameness or imbalance proxy), and bend quality in turns. All outputs must be derived from physics and signal processing rather than heuristics.

A horse is a limit-cycle oscillator. Each gait produces a characteristic pattern of oscillation frequency, beat count, left-right symmetry, and vertical–rotational coupling. The rider is a movable mass on top of this oscillator. Crookedness, rein imbalance, lead issues, rider asymmetry, and tension appear as lateral acceleration bias, yaw drift, phase asymmetry, and rotational coupling in the IMU signals.

The Horse Profile must be used as follows. Height determines stride scaling. Weight affects vertical acceleration amplitude and should be used to normalize RMS(Z). Age affects joint stiffness and slightly widens gait thresholds for very young or old horses. Breed provides priors for preferred frequency; for example, ponies have higher f0 than warmbloods. These parameters also inform rhythm expectations.

The app receives from CoreMotion the userAcceleration vector ax, ay, az, the rotationRate vector gx, gy, gz, and the device attitude quaternion. Rotate the acceleration into the horse-relative frame using the quaternion so that Z is vertical, X is forward–back, and Y is left–right. Gravity is already removed by userAcceleration.

Process data in sliding windows of 2.5 seconds with 80 percent overlap at approximately 100 Hz. For each window, extract Z(t), X(t), Y(t), yaw rate, and roll rate. Apply a Hann window and compute FFTs of Z, X, and yaw rate. Compute power spectra Pz, Px, and Pyaw. Find the stride frequency f0 as the frequency between 0.5 and 6 Hz with the maximum vertical power Pz, adjusting expected f0 range based on breed and height priors from the Horse Profile. Compute harmonic ratios H2 equal to Pz at 2f0 divided by Pz at f0, and H3 equal to Pz at 3f0 divided by Pz at f0. Compute magnitude-squared coherence at f0 between X and Y, and between Z and yaw rate to measure left-right symmetry and vertical-rotational coupling. Compute the analytic signal of Z using a Hilbert transform and extract its phase to detect symmetry and phase locking.

For each window, build a feature vector consisting of f0, H2, H3, spectral entropy of the vertical spectrum, coherence between X and Y at f0, coherence between Z and yaw at f0, RMS of Z normalized by horse weight, RMS of yaw rate, Apple Watch left-right arm symmetry, and Apple Watch yaw energy. Use these features to classify gait with priors adjusted by horse height, age, and breed. Walk has f0 between 1 and 2.2 Hz, H2 0.3–0.7, H3 0.2–0.5, low coherence and low entropy. Trot has f0 2–3.8 Hz, H2 > 1.2, very high left-right coherence, and low vertical-yaw coherence. Canter has f0 1.8–3 Hz, H3 > H2, low left-right coherence but high vertical-yaw coherence. Gallop has f0 > 3 Hz, weak harmonics, high entropy, and strong yaw coupling. Adjust ranges based on horse height, breed, and age.

Use a Hidden Markov Model with states walk, trot, canter, and gallop, allowing only transitions walk to trot, trot to canter, canter to gallop, and the reverse. Compute the probability of each gait from the feature stream using the forward algorithm to remove flicker and enforce physically possible transitions.

To detect canter lead, use lateral acceleration Y and yaw rate. Compute the phase of each via Hilbert transform and take the phase difference phi equal to phase of Y minus phase of yaw. Mean phi approximately +90 degrees indicates left lead; −90 degrees indicates right lead. Track lead consistency as the percentage of time spent on the correct lead and the number of unintended lead changes.

Rein balance is measured as persistent lateral bias. Compute the RMS of Y where Y is positive and negative. Define rein balance as (left minus right) divided by (left plus right). Straightness is measured by the mean yaw rate and lateral acceleration. Turn balance is measured by comparing measured lateral acceleration to the expected centripetal acceleration from speed and turn radius. Canter lead quality is measured as the product of vertical-yaw coherence and the magnitude of the lead phase signal.

Speed is derived from GPS. Stride frequency f0 is extracted from the FFT spectral peak as described above. Rider symmetry is derived from Apple Watch arm swing and yaw energy.

Compute additional ride summary insights for the session: rhythm and regularity from stride-to-stride timing (e.g., coefficient of variation of stride periods), transition quality from the speed of gait stabilization, lead consistency, symmetry score (left-right balance), and bend quality in turns. Visualize gait attractors as Z versus dZ, Z versus yaw, and Y versus yaw for debugging and validation.

Never use raw acceleration magnitude, step counting, peak detection, or posture heuristics, as these fail when the rider changes seat. The system must output all metrics in real time using vDSP FFTs, Welch coherence, and a four-state Hidden Markov Model running at 2–4 updates per second, and incorporate the Horse Profile to personalize calculations.